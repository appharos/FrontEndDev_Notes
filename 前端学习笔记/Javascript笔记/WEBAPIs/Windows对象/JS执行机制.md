## JS 执行机制


JavaScript 的执行机制是基于“事件循环”（Event Loop）的，它是单线程的，意味着同一时间只能执行一个任务。然而，通过使用异步操作，JavaScript 能够处理高并发的任务。了解这个机制对于编写高效和响应式的应用程序非常重要。

### 执行栈（Execution Stack）
当一个脚本首次运行时，JavaScript 引擎会创建一个全局执行上下文，并将其压入当前的执行栈。每当一个函数被调用，一个新的执行上下文被创建并压入栈顶。当函数运行完毕，其执行上下文将从栈顶弹出，控制权返回到当前栈顶的执行上下文。

### 事件循环（Event Loop）
事件循环是 JavaScript 引擎的一部分，它监视执行栈并决定何时调度任务。如果执行栈为空，并且消息队列中有待处理的消息，事件循环会将第一个消息的回调函数压入执行栈中执行。

### 消息队列（Message Queue）
当异步事件发生时（如用户点击、定时器到期、AJAX 请求完成等），相应的回调函数被加入到消息队列中等待执行。如果执行栈为空，事件循环会从消息队列中取出一个消息并执行其回调函数。

### 微任务（Microtask）
微任务是一种特殊的任务，它们的优先级高于常规的消息队列任务。Promise回调就是一种微任务。当一个微任务队列不为空时，事件循环会在处理下一个消息之前，首先清空微任务队列。

### JS 的执行过程
1. **全局代码执行**: 首先执行全局代码，创建全局执行上下文，并将其压入执行栈。
2. **函数调用**: 当调用一个函数时，创建一个新的执行上下文，并将其压入栈顶。
3. **异步任务**: 异步任务如事件监听器、定时器等，它们的回调函数不会立即执行，而是被放到消息队列中等待。
4. **事件循环**: 当执行栈为空时，事件循环开始工作，从消息队列中取出任务执行。
5. **执行异步回调**: 异步任务的回调函数被创建为一个新的执行上下文，并压入执行栈中执行。
6. **处理微任务**: 在当前执行栈清空之前，所有的微任务（如 Promise 的 then/catch/finally 回调）都会被执行。
7. **返回事件循环**: 完成当前任务后，返回事件循环，等待下一个任务。

通过理解 JavaScript 的执行机制，开发者能够更好地编写非阻塞性能更好的代码，并能更有效地利用异步编程模式。